<div class="legal-container">
    <div class="legal-header"></div>
    <ul class="legal-list" id="legal-list">
        {{ $isLegalPage := and (eq .context.Kind "page") (eq .context.File.BaseFileName "Legal_field") }}
        {{ $currentPageSlug := .context.File.BaseFileName }}
        {{ $showNumbers := .displayNumbers }}
        {{ $counter := 0 }}

        {{ $legalToDisplay := .context.Site.Data.Legal_field }}

        {{ if not $isLegalPage }}
            {{ $legalToDisplay = slice }}
            {{ range .context.Site.Data.Legal_field }}
                {{ if in .referenced_in $currentPageSlug }}
                    {{ $legalToDisplay = $legalToDisplay | append . }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{ range $legalToDisplay }}
            {{ $counter = add $counter 1 }}

            {{/* –ì–ï–ù–ï–†–ê–¶–ò–Ø cardId */}}
            {{ $cardId := "" }}
            {{ with .anchor }}
                {{ $cardId = trim . " " }}
            {{ end }}
            {{ if eq $cardId "" }}
                {{ with .name }}
                    {{ $cardId = . | urlize }}
                {{ else }}
                    {{ $cardId = printf "legal-%d" $counter }}
                {{ end }}
            {{ end }}

            <li class="legal-item"
                id="card-{{ $cardId }}"
                data-card-id="{{ $cardId }}"
                data-legal-number="{{ $counter }}"
                data-legal-name="{{ .name | default .title }}">

                <!-- –ö–û–†–û–¢–ö–ò–ô –í–ò–î -->
                <span class="legal-item-short">
                    {{ if $showNumbers }}
                        <span class="legal-number">{{ $counter }}.</span>
                        <span class="legal-name">{{ .name | default .title }}</span>
                    {{ end }}
                </span>

                <!-- –ü–û–õ–ù–´–ô –í–ò–î -->
                <span class="legal-item-full" style="display: none;">
                    <span class="legal-item-header">
                        <span class="legal-number">{{ $counter }}.</span>
                        <span class="legal-name">{{ .name | default .title }}</span>
                    </span>
                    <div class="legal-details">
                        <p>
                            {{ with .type }}<strong>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> {{ . }}<br>{{ end }}
                            {{ with .date }}<strong>–î–∞—Ç–∞:</strong> {{ . }}<br>{{ end }}
                            {{ with .authority }}<strong>–û—Ä–≥–∞–Ω:</strong> {{ . }}<br>{{ end }}
                            {{ .description }}
                            <br>
                            {{ if .url }}
                                <a href="{{ .url }}" target="_blank">{{ .url }}</a>
                            {{ end }}
                        </p>

                        <!-- –°–°–´–õ–ö–ê -->
                        {{ $collectionBaseUrl := "/docs/reference-books/Legal_field/" }}
                        <div class="legal-item-more-details">
                            <a href="{{ $collectionBaseUrl }}#card-{{ $cardId }}"
                               class="more-details-button"
                               onclick="return saveScrollPositionForLegal(event)">
                                More detailed
                            </a>
                        </div>
                    </div>
                </span>
            </li>
        {{ end }} <!-- –ó–ê–ö–†–´–í–ê–ï–ú range –∑–¥–µ—Å—å -->
    </ul>
</div>

<!-- –°–ö–†–ò–ü–¢ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø–æ hash - –ü–û–°–õ–ï –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö Hugo –±–ª–æ–∫–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    console.log('LEGAL FIELD DEBUG: –¢–µ–∫—É—â–∏–π hash:', hash);

    if (hash && hash.startsWith('#card-')) {
        const cardId = hash.substring(6); // –£–±–∏—Ä–∞–µ–º "#card-"
        console.log('LEGAL FIELD DEBUG: –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å ID:', cardId);

        const card = document.getElementById('card-' + cardId);
        if (card) {
            console.log('‚úÖ LEGAL FIELD: –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞–π–¥–µ–Ω–∞');

            const full = card.querySelector('.legal-item-full');
            const short = card.querySelector('.legal-item-short');

            if (full && short) {
                console.log('LEGAL FIELD: Full/Short —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã');
                console.log('–î–æ - full.display:', full.style.display);
                console.log('–î–æ - short.display:', short.style.display);

                full.style.display = 'block';
                short.style.display = 'none';

                console.log('–ü–æ—Å–ª–µ - full.display:', full.style.display);
                console.log('–ü–æ—Å–ª–µ - short.display:', short.style.display);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                card.classList.add('is-expanded');

                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                setTimeout(() => {
                    card.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    console.log('‚úÖ LEGAL FIELD: –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞ –∏ –ø—Ä–æ–∫—Ä—É—á–µ–Ω–∞');
                }, 150);
            } else {
                console.log('‚ùå LEGAL FIELD: Full –∏–ª–∏ Short —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                if (!full) console.log('  - –ù–µ –Ω–∞–π–¥–µ–Ω .legal-item-full');
                if (!short) console.log('  - –ù–µ –Ω–∞–π–¥–µ–Ω .legal-item-short');
            }
        } else {
            console.log('‚ùå LEGAL FIELD: –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ ID card-' + cardId);

            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
            const allLegalCards = document.querySelectorAll('.legal-item');
            console.log('–í—Å–µ legal –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', allLegalCards.length);

            // –ò—â–µ–º –ø–æ data-card-id
            const cardByDataId = document.querySelector('.legal-item[data-card-id="' + cardId + '"]');
            console.log('–ù–∞—à–ª–∏ –ø–æ data-card-id:', !!cardByDataId);

            // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–∫—Ä—ã—Ç—å –µ—Å–ª–∏ –Ω–∞—à–ª–∏
            if (cardByDataId) {
                console.log('‚úÖ –ù–∞—à–ª–∏ –ø–æ data-card-id!');
                const full = cardByDataId.querySelector('.legal-item-full');
                const short = cardByDataId.querySelector('.legal-item-short');

                if (full && short) {
                    full.style.display = 'block';
                    short.style.display = 'none';
                    cardByDataId.classList.add('is-expanded');

                    setTimeout(() => {
                        cardByDataId.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }, 150);
                }
            }
        }
    } else {
        console.log('LEGAL FIELD: –ù–µ—Ç hash –∏–ª–∏ hash –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å #card-');
    }
});

// –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è hash
window.addEventListener('hashchange', function() {
    console.log('LEGAL FIELD: Hash –∏–∑–º–µ–Ω—ë–Ω –Ω–∞', window.location.hash);
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –∏–ª–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è/–æ—Ç–∫—Ä—ã—Ç–∏—è
    setTimeout(() => {
        location.reload();
    }, 100);
});
</script>

<script>
// –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–õ–Ø LEGAL
function saveScrollPositionForLegal(event) {
    console.log('üìç [LEGAL] –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞...');

    // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É
    const link = event.currentTarget;
    const card = link.closest('.legal-item');

    if (!card) {
        console.error('‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return true;
    }

    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
    const legalNumber = card.getAttribute('data-legal-number');

    // –û—á–∏—â–∞–µ–º –í–°–Å –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
    sessionStorage.clear();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –ò –Ω–æ–º–µ—Ä
    sessionStorage.setItem('markerType', 'legal');  // –ö–õ–Æ–ß–ï–í–û–ï!
    sessionStorage.setItem('markerNumber', legalNumber);
    sessionStorage.setItem('scrollTop', window.pageYOffset);
    sessionStorage.setItem('timestamp', Date.now());

    console.log('üíæ [LEGAL] –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Ç–∏–ø: legal, –Ω–æ–º–µ—Ä:', legalNumber);

    return true; // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥
}
</script>


